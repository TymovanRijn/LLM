<!DOCTYPE html>
<html>
  <head>
    <title>Chat App</title>
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./static/chatbox.css" />
    <link rel="stylesheet" href="./static/offerte.css" />
    <!-- mCustomScrollbar CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- mCustomScrollbar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
  </head>
  <body>
    <div class="current-offerte">
      <h3>Current Quote</h3>
      <table id="offerteTable">
        <thead>
          <tr>
            <th>Item</th>
            <th>Quantity</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody>
          <!-- Offerte items worden hier ingeladen via AJAX -->
        </tbody>
      </table>
    </div>
    <div class="chat">
      <div class="chat-title">
        <h1>Chat Assistant</h1>
        <h2>Blis Digital</h2>
        <figure class="avatar">
          <img src="./static/avatar_icon.png" />
        </figure>
      </div>
      <div class="messages">
        <div class="messages-content"></div>
      </div>
      <div class="message-box">
        <textarea
          type="text"
          class="message-input"
          placeholder="Type message..."
        ></textarea>
        <button type="submit" class="message-submit">Send</button>
      </div>
    </div>
    <div class="bg"></div>

    <script>
      $(document).ready(function () {
        var $messages = $(".messages-content"),
          d,
          h,
          m;
        $messages.mCustomScrollbar();

        function updateScrollbar() {
          $messages
            .mCustomScrollbar("update")
            .mCustomScrollbar("scrollTo", "bottom", {
              scrollInertia: 10,
              timeout: 0,
            });
        }

        function insertMessage() {
          var msg = $(".message-input").val();
          if ($.trim(msg) == "") {
            return false;
          }
          $('<div class="message message-personal">' + msg + "</div>")
            .appendTo($(".mCSB_container"))
            .addClass("new");
          $(".message-input").val(null);
          updateScrollbar();
          // Verzend het bericht naar de server
          $.ajax({
            url: "/send_message",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ message: msg }),
            success: function (response) {
              // Voeg het antwoord van de assistent toe aan de chat
              $(
                '<div class="message new"><figure class="avatar"><img src="./static/avatar_icon.png" /></figure>' +
                  response.response +
                  "</div>"
              )
                .appendTo($(".mCSB_container"))
                .addClass("new");
              updateScrollbar();
            },
          });
        }

        $(".message-submit").click(function () {
          insertMessage();
        });

        $(window).on("keydown", function (e) {
          if (e.which == 13) {
            insertMessage();
            return false;
          }
        });
      });

      function loadOfferteData() {
        $.ajax({
          url: "/get_offerte_data",
          type: "GET",
          success: function (response) {
            $("#offerteTable tbody").empty();
            let totaalPrijs = 0; // Initialiseer een variabele om de totale prijs bij te houden

            if (response.length > 0) {
              const item = response[0]; // Aangenomen dat er maar één item (ID=1) wordt geladen

              // Loop eerst door alle normale velden die niet beginnen met 'Prijs_'
              Object.keys(item).forEach(function (key) {
                if (!key.startsWith("Prijs_") && key !== "ID" && key !== "m2") {
                  // Veronderstelt dat ID en m2 niet als aparte rijen getoond moeten worden
                  var value = item[key] === null ? "N/A" : item[key];
                  var prijsKey = "Prijs_" + key;
                  var prijsValue = item[prijsKey]
                    ? item[prijsKey].toFixed(2)
                    : "N/A";
                  if (item[prijsKey]) totaalPrijs += parseFloat(item[prijsKey]); // Voeg toe aan totaal als er een prijs is

                  var row = `<tr>
                                <td class="column-name">${key}</td>
                                <td class="column-value">${value}</td>
                                <td class="column-price">${prijsValue}</td>
                            </tr>`;
                  $("#offerteTable tbody").append(row);
                }
              });

              // Speciale rij voor m2 als die bestaat
              if (item["m2"] !== null && item["m2"] !== undefined) {
                var m2Row = `<tr>
                            <td class="column-name">m2</td>
                            <td class="column-value">${item["m2"]}</td>
                            <td class="column-price">-</td>
                        </tr>`;
                $("#offerteTable tbody").append(m2Row);
              }

              // Voeg na het itereren over alle velden, een totaalrij toe aan de tabel
              var totaalRij = `<tr>
                        <td class="column-name">Totaal</td>
                        <td></td>
                        <td class="column-price">${totaalPrijs.toFixed(2)}</td>
                    </tr>`;
              $("#offerteTable tbody").append(totaalRij);
            }
          },
          error: function (error) {
            console.log("Error loading offerte data:", error);
          },
        });
      }

      $(document).ready(function () {
        loadOfferteData(); // Roep deze functie aan wanneer de pagina geladen is
        // De rest van je document.ready functie...
      });
    </script>
  </body>
</html>
